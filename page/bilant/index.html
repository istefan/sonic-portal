
<!DOCTYPE html>
<html lang="en" data-bs-theme="auto">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>SONIC DPS</title>

    <script src="../../js/color-modes.js"></script>


    <link href="../../css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.1/nouislider.min.css" />
    <link href="../../css/style.css" rel="stylesheet">
    
    <link rel="apple-touch-icon" href="../../images/apple-touch-icon.png" sizes="180x180">
    <link rel="icon" href="../../images/favicon-32x32.png" sizes="32x32" type="image/png">
    <link rel="icon" href="../../images/favicon-16x16.png" sizes="16x16" type="image/png">
    <link rel="mask-icon" href="../../images/safari-pinned-tab.svg" color="#712cf9">
    <link rel="icon" href="../../images/favicon.ico">

    <link rel="manifest" href="../../manifest.json">
    <meta name="theme-color" content="#712cf9">
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof bootstrap === 'undefined') {
                console.error('Bootstrap JS is required but not loaded');
            }
        });
    </script>
</head>
<body>
    <header class="navbar sticky-top bg-white flex-md-nowrap p-1" data-bs-theme="light">
        <a class="navbar-brand me-0 px-3 fs-6" href="../../index.html">
            <img src="../../images/logo.svg" alt="Vuestic Admin Logo" height="24">
            <span class="ms-2 brand-text">SONIC DPS</span>
        </a>
        <ul class="navbar-nav flex-row ms-auto"> <!-- Added ms-auto to push to right -->
            <li class="nav-item dropdown user-dropdown">
                <a class="nav-link px-3 dropdown-toggle" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false" title="Account preferences">
                    <i class="bi bi-person" aria-hidden="true"></i>
                </a>
                <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="navbarDropdown">
                    <li><a class="dropdown-item" href="../../page/contul-meu/index.html">Editare profil</a></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><a class="dropdown-item" href="../../login.html">Ieșire din cont</a></li>
                </ul>
            </li>
        </ul>
        <ul class="navbar-nav flex-row d-md-none">
            <li class="nav-item text-nowrap">
                <button class="nav-link px-3 text-dark" type="button" data-bs-toggle="offcanvas" data-bs-target="#sidebarMenu" aria-controls="sidebarMenu" aria-expanded="false" aria-label="Toggle navigation">
                    <i class="bi bi-list" aria-hidden="true"></i>
                </button>
            </li>
        </ul>
    </header>

    <div class="container-fluid">
        <div class="row">
<!-- Resurse pentru dropdown-ul cu cautare (Tom Select) -->
<link href="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/css/tom-select.bootstrap5.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/js/tom-select.complete.min.js"></script>
<div class="sidebar p-0 bg-white">
    <div class="offcanvas-md offcanvas-end bg-white" tabindex="-1" id="sidebarMenu" aria-labelledby="sidebarMenuLabel">
        <div class="offcanvas-header">
            <h5 class="offcanvas-title" id="sidebarMenuLabel">SONIC DPS</h5>
            <button type="button" class="btn-close" data-bs-dismiss="offcanvas" data-bs-target="#sidebarMenu" aria-label="Close"></button>
        </div>
        <div class="offcanvas-body d-md-flex flex-column p-0 pt-lg-3 overflow-y-auto">
            
            <ul class="nav flex-column">
                <li class="nav-item">
                    <a class="nav-link d-flex align-items-center gap-2 " aria-current="page" href="../../index.html">
                        <i class="bi bi-display" aria-hidden="true"></i> Panoul Meu
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link d-flex align-items-center gap-2 " href="../../page/adrese/index.html">
                        <i class="bi bi-geo-alt" aria-hidden="true"></i> Adresele Mele
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link d-flex align-items-center gap-2 " href="../../page/regiuni/index.html">
                        <i class="bi bi-bounding-box" aria-hidden="true"></i> Regiuni / Zone
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link d-flex align-items-center gap-2 " href="../../page/perioade-calcul/index.html">
                        <i class="bi bi-calendar-check" aria-hidden="true"></i> Perioade Citiri
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link d-flex align-items-center gap-2 " href="../../page/setari-alerte/index.html">
                        <i class="bi bi-bell" aria-hidden="true"></i> Setări Alerte
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link d-flex align-items-center gap-2 " href="../../page/info-center/index.html">
                        <i class="bi bi-info-circle" aria-hidden="true"></i> Info Center
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link d-flex align-items-center gap-2 " href="../../page/contact/index.html">
                        <i class="bi bi-envelope" aria-hidden="true"></i> Contact
                    </a>
                </li>
            </ul>

            <h6 class="sidebar-heading d-flex justify-content-between align-items-center px-3 mt-4 mb-1 text-body-secondary text-uppercase">
                <span>Rapoarte</span>
            </h6>
            <ul class="nav flex-column mb-auto">
                <li class="nav-item">
                    <a class="nav-link d-flex align-items-center gap-2 " href="../../page/citiri/index.html">
                        <i class="bi bi-calendar-day" aria-hidden="true"></i> Raport Citiri
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link d-flex align-items-center gap-2 active" href="../../page/bilant/index.html">
                        <i class="bi bi-pie-chart" aria-hidden="true"></i> Bilanț Neînchideri Apă
                    </a>
                </li>
                 <li class="nav-item">
                    <a class="nav-link d-flex align-items-center gap-2 " href="../../page/estimari/index.html">
                        <i class="bi bi-graph-up-arrow" aria-hidden="true"></i> Estimări Consum
                    </a>
                </li>
                 <!-- MODIFICARE: Link nou adaugat -->
                <li class="nav-item">
                    <a class="nav-link d-flex align-items-center gap-2 " href="../../page/alerte/index.html">
                        <i class="bi bi-exclamation-triangle" aria-hidden="true"></i> Raport Alerte
                    </a>
                </li>
            </ul>

            <h6 class="sidebar-heading d-flex justify-content-between align-items-center px-3 mt-4 mb-1 text-body-secondary text-uppercase">
                <span>Administrare</span>
            </h6>
            <ul class="nav flex-column mb-auto">
                <li class="nav-item">
                    <a class="nav-link d-flex align-items-center gap-2 " href="../../page/contul-meu/index.html">
                        <i class="bi bi-person-gear" aria-hidden="true"></i> Contul Meu
                    </a>
                </li>
            </ul>

            <h6 class="sidebar-heading d-flex justify-content-between align-items-center px-3 mt-4 mb-1 text-body-secondary text-uppercase">
                <span>Admin Sistem</span>
            </h6>
            <ul class="nav flex-column mb-auto">
                <li class="nav-item">
                    <a class="nav-link d-flex align-items-center gap-2 " href="../../page/users/index.html">
                        <i class="bi bi-people" aria-hidden="true"></i> Utilizatori
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link d-flex align-items-center gap-2 " href="../../page/settings/index.html">
                        <i class="bi bi-receipt" aria-hidden="true"></i> Setari Aplicatie
                    </a>
                </li>
            </ul>
        </div>
    </div>
</div>

<main class="main px-md-4"><div class="container-full-width">

    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3">
        <div>
            <h1>Bilanț Neînchideri Apă</h1>
            <!-- MODIFICARE: Textul explicativ a fost actualizat -->
            <p class="text-muted mb-0">Pentru un calcul corect al bilanțului, asigurați-vă că ați încărcat valorile facturate în secțiunea <a href="../../page/furnizori/index.html">Facturi Furnizori</a>.</p>
        </div>
    </div>

    <!-- START: Filtru Loc de Masurare (Neschimbat) -->
    <div class="card mb-4">
        <div class="card-body">
            <div class="row align-items-end">
                <div class="col-lg-9">
                    <label for="selectLocMasurare" class="form-label">Filtrează după Loc de Măsurare:</label>
                    <select id="selectLocMasurare" placeholder="Caută și selectează o adresă..." autocomplete="off">
                        <option value="1">Str. Libertății, Nr. 24, Bloc C2</option>
                        <option value="2">B-dul Unirii, Nr. 10, Bloc A5</option>
                        <option value="3">Aleea Trandafirilor, Nr. 5</option>
                    </select>
                </div>
                <div class="col-lg-3 d-flex justify-content-end mt-3 mt-lg-0">
                    <button class="btn btn-primary me-2 flex-grow-1"><i class="bi bi-funnel me-2"></i>Aplică</button>
                    <button class="btn btn-success flex-grow-1"><i class="bi bi-file-earmark-excel me-2"></i>Exportă</button>
                </div>
            </div>
        </div>
    </div>
    <!-- END: Filtru Loc de Masurare -->

    <div class="row mb-4">
        <!-- Grafic Apa Rece -->
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-body text-center">
                    <h5 class="card-title text-muted mb-3">Neînchidere Apă Rece</h5>
                    <div style="height: 250px; position: relative;">
                        <canvas id="bilantChartRece"></canvas>
                    </div>
                </div>
            </div>
        </div>
        <!-- Grafic Apa Calda -->
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-body text-center">
                    <h5 class="card-title text-muted mb-3">Neînchidere Apă Caldă</h5>
                     <div style="height: 250px; position: relative;">
                        <canvas id="bilantChartCalda"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- MODIFICARE: Sectiunea de selectie a perioadei a fost complet refacuta -->
    <div class="card mb-4">
        <div class="card-body">
            <h5 class="card-title">Alege perioada pentru calcularea bilanțului de neînchideri</h5>
            <div class="row g-3 align-items-end">
                <div class="col-md-5">
                    <label for="selectStartMonth" class="form-label">De La</label>
                    <select class="form-select" id="selectStartMonth"></select>
                </div>
                <div class="col-md-5">
                     <label for="selectEndMonth" class="form-label">Până La</label>
                     <select class="form-select" id="selectEndMonth"></select>
                </div>
                <div class="col-md-2">
                    <button id="setarePerioadaBtn" class="btn btn-primary w-100">Setează Perioada</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Tabel cu neinchideri detaliate -->
    <div class="card">
        <!-- MODIFICARE: Adaugat card-body pentru padding -->
        <div class="card-body">
            <h5 class="mb-3" id="tabelTitlu">Neînchideri lunare detaliate</h5>
            <div class="table-responsive">
                <table class="table table-striped table-hover mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>Perioada Calcul</th>
                            <th>AR Facturată m³</th>
                            <th>AR Contoare m³</th>
                            <th>AR Diferență m³</th>
                            <th>AC Facturată m³</th>
                            <th>AC Contoare m³</th>
                            <th>AC Diferență m³</th>
                        </tr>
                    </thead>
                    <tbody id="bilantTabelBody">
                        <!-- Continutul va fi generat dinamic de JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div></main>

<script>
function initializeBilantPage() {
    
    // --- PASUL 1: SURSA DE DATE CENTRALA ---
    // In productie, aceste date vor veni de la un API.
    const bilantData = [
        { perioada: "Octombrie 2024", id: "2024-10", arFact: 50.10, arCont: 48.90, acFact: 35.00, acCont: 33.50 },
        { perioada: "Noiembrie 2024", id: "2024-11", arFact: 53.63, arCont: 53.28, acFact: 37.09, acCont: 36.34 },
        { perioada: "Decembrie 2024", id: "2024-12", arFact: 66.64, arCont: 47.35, acFact: 41.99, acCont: 35.97 },
        { perioada: "Ianuarie 2025", id: "2025-01", arFact: 51.36, arCont: 51.03, acFact: 36.45, acCont: 43.10 },
        { perioada: "Februarie 2025", id: "2025-02", arFact: 50.03, arCont: 52.60, acFact: 36.43, acCont: 38.54 },
        { perioada: "Martie 2025", id: "2025-03", arFact: 49.15, arCont: 48.90, acFact: 34.32, acCont: 34.81 },
        { perioada: "Aprilie 2025", id: "2025-04", arFact: 67.30, arCont: 58.23, acFact: 39.34, acCont: 36.44 },
        { perioada: "Mai 2025", id: "2025-05", arFact: 64.06, arCont: 59.38, acFact: 68.24, acCont: 34.35 },
        { perioada: "Iunie 2025", id: "2025-06", arFact: 68.30, arCont: 65.05, acFact: 28.72, acCont: 30.51 },
        { perioada: "Iulie 2025", id: "2025-07", arFact: 60.14, arCont: 53.22, acFact: 28.42, acCont: 25.15 },
        { perioada: "August 2025", id: "2025-08", arFact: 56.25, arCont: 54.35, acFact: 23.92, acCont: 22.76 },
        { perioada: "Septembrie 2025", id: "2025-09", arFact: 58.00, arCont: 55.50, acFact: 25.00, acCont: 24.00 }
    ];

    // --- PASUL 2: INITIALIZARE GRAFICE (goale initial) ---
    const createDoughnutChart = (canvasId) => {
        const ctx = document.getElementById(canvasId).getContext('2d');
        return new Chart(ctx, {
            type: 'doughnut', data: { labels: [], datasets: [{ data: [], backgroundColor: [] }] },
            options: { responsive: true, maintainAspectRatio: false, cutout: '60%', /* mai gros */ plugins: { legend: { position: 'bottom' } } }
        });
    };
    const chartRece = createDoughnutChart('bilantChartRece');
    const chartCalda = createDoughnutChart('bilantChartCalda');

    // --- PASUL 3: FUNCTIILE DE ACTUALIZARE ---
    function updateDoughnutChart(chartInstance, totalFacturat, totalContoare, color1, color2) {
        const total = totalFacturat;
        const neinchidere = total - totalContoare;
        
        const procentContoare = total > 0 ? (totalContoare / total * 100) : 0;
        const procentNeinchidere = total > 0 ? (neinchidere / total * 100) : 0;

        chartInstance.data.labels = [`Contoare: ${procentContoare.toFixed(2)}%`, `Neînchidere: ${procentNeinchidere.toFixed(2)}%`];
        chartInstance.data.datasets[0].data = [procentContoare, procentNeinchidere];
        chartInstance.data.datasets[0].backgroundColor = [color1, color2];
        chartInstance.update();
    }

    function updateDisplay(startPeriodId, endPeriodId) {
        // Filtrare date
        const startIndex = bilantData.findIndex(d => d.id === startPeriodId);
        const endIndex = bilantData.findIndex(d => d.id === endPeriodId);
        const filteredData = bilantData.slice(startIndex, endIndex + 1);

        // Actualizare titlu tabel
        document.getElementById('tabelTitlu').textContent = `Neînchideri lunare detaliate pentru perioada ${filteredData[0].perioada} - ${filteredData[filteredData.length-1].perioada}`;

        // Actualizare tabel
        const tabelBody = document.getElementById('bilantTabelBody');
        tabelBody.innerHTML = filteredData.map(row => `
            <tr>
                <td>${row.perioada}</td>
                <td>${row.arFact.toFixed(2)}</td>
                <td>${row.arCont.toFixed(2)}</td>
                <td>${(row.arFact - row.arCont).toFixed(2)}</td>
                <td>${row.acFact.toFixed(2)}</td>
                <td>${row.acCont.toFixed(2)}</td>
                <td>${(row.acFact - row.acCont).toFixed(2)}</td>
            </tr>
        `).join('');

        // Calcul totaluri si actualizare grafice
        const totalArFact = filteredData.reduce((sum, row) => sum + row.arFact, 0);
        const totalArCont = filteredData.reduce((sum, row) => sum + row.arCont, 0);
        const totalAcFact = filteredData.reduce((sum, row) => sum + row.acFact, 0);
        const totalAcCont = filteredData.reduce((sum, row) => sum + row.acCont, 0);

        updateDoughnutChart(chartRece, totalArFact, totalArCont, 'rgba(54, 162, 235, 0.8)', 'rgba(201, 203, 207, 0.8)');
        updateDoughnutChart(chartCalda, totalAcFact, totalAcCont, 'rgba(255, 99, 132, 0.8)', 'rgba(201, 203, 207, 0.8)');
    }

    // --- PASUL 4: CONFIGURARE SELECTOARE DE LUNI ---
    const startMonthSelect = document.getElementById('selectStartMonth');
    const endMonthSelect = document.getElementById('selectEndMonth');
    
    bilantData.forEach(item => {
        startMonthSelect.innerHTML += `<option value="${item.id}">${item.perioada}</option>`;
        endMonthSelect.innerHTML += `<option value="${item.id}">${item.perioada}</option>`;
    });

    // Setare valori implicite (ultimele 12 luni)
    const defaultStartIndex = Math.max(0, bilantData.length - 12);
    startMonthSelect.value = bilantData[defaultStartIndex].id;
    endMonthSelect.value = bilantData[bilantData.length - 1].id;

    // Adaugare event listener pe buton
    document.getElementById('setarePerioadaBtn').addEventListener('click', () => {
        updateDisplay(startMonthSelect.value, endMonthSelect.value);
    });

    // Incarcare date initiale
    updateDisplay(startMonthSelect.value, endMonthSelect.value);
}

function waitForDependencies() {
    if (typeof Chart !== 'undefined' && typeof TomSelect !== 'undefined') {
        initializeBilantPage();
        new TomSelect("#selectLocMasurare",{ create: false });
    } else {
        setTimeout(waitForDependencies, 50);
    }
}
document.addEventListener('DOMContentLoaded', waitForDependencies);
</script>

        </div>
    </div>

    <script src="../../js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.3.2/dist/chart.umd.js" integrity="sha384-eI7PSr3L1XLISH8JdDII5YN/njoSsxfbrkCTnJrzXt+ENP5MOVBxD+l6sEG4zoLp" crossorigin="anonymous" class="astro-vvvwv3sm"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.1/nouislider.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/wnumb/1.2.0/wNumb.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://npmcdn.com/flatpickr/dist/l10n/ro.js"></script>
    <script src="../../js/dashboard.js" class="astro-vvvwv3sm"></script>
</body>
</html>